<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Assign Number to Group</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background: linear-gradient(120deg, #f8fafc 0%, #e0e7ef 100%);
        min-height: 100vh;
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        padding: 2rem 1rem;
      }
      
      .container {
        background: #fff;
        padding: 2.5rem 2rem;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(60, 72, 100, 0.12);
        max-width: 700px;
        margin: 0 auto;
        animation: fadeInUp 0.7s;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(40px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      h1 {
        text-align: center;
        color: #2d3748;
        margin-bottom: 2rem;
        font-size: 2rem;
        font-weight: 600;
      }
      
      .form-section {
        margin-bottom: 2rem;
      }
      
      .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .form-grid {
        display: grid;
        gap: 1.5rem;
      }
      
      .form-group {
        display: flex;
        flex-direction: column;
      }
      
      .form-label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }
      
      .form-input {
        padding: 0.75rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        background: #f8fafc;
        transition: all 0.2s;
        font-family: inherit;
      }
      
      .form-input:focus {
        outline: none;
        border-color: #7f9cf5;
        box-shadow: 0 0 0 2px rgba(127, 156, 245, 0.2);
        background: #fff;
      }
      
      .form-input::placeholder {
        color: #9ca3af;
      }
      
      .status-group {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        margin-top: 0.5rem;
      }
      
      .status-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        color: #374151;
        cursor: pointer;
        transition: color 0.2s;
      }
      
      .status-option:hover {
        color: #7f9cf5;
      }
      
      .status-option input[type="radio"] {
        width: 16px;
        height: 16px;
        accent-color: #7f9cf5;
      }
      
      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        flex-wrap: wrap;
      }
      
      .action-btn {
        background: linear-gradient(90deg, #7f9cf5 0%, #667eea 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 0.8rem 2rem;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        min-width: 120px;
      }
      
      .action-btn:hover {
        background: linear-gradient(90deg, #667eea 0%, #7f9cf5 100%);
        transform: translateY(-2px) scale(1.03);
      }
      
      .action-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }
      
      .action-btn.secondary {
        background: linear-gradient(90deg, #6b7280 0%, #4b5563 100%);
      }
      
      .action-btn.secondary:hover {
        background: linear-gradient(90deg, #4b5563 0%, #6b7280 100%);
      }
      
      .back-link {
        display: inline-block;
        background: #6b7280;
        color: #fff;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s;
        margin-top: 1.5rem;
      }
      
      .back-link:hover {
        background: #4b5563;
        transform: translateY(-2px) scale(1.03);
      }
      
      .notification {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        font-weight: 500;
        display: none;
      }
      
      .notification.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }
      
      .notification.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      
      .notification.show {
        display: block;
        animation: slideIn 0.3s ease-out;
      }
      
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .form-row {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1rem;
        align-items: end;
      }
      
      .preview-section {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        border: 1px solid #e2e8f0;
      }
      
      .preview-title {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .preview-content {
        background: #fff;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        font-family: monospace;
        font-size: 0.9rem;
        color: #4b5563;
        white-space: pre-wrap;
      }
      
      .input-group {
        position: relative;
      }
      
      .input-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 1.1rem;
      }
      
      .input-with-icon {
        padding-left: 2.5rem;
      }
      
      .required-indicator {
        color: #ef4444;
        font-size: 0.8rem;
        margin-left: 0.25rem;
      }
      
      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: 1.5rem 1rem;
        }
        
        h1 {
          font-size: 1.6rem;
        }
        
        .form-row {
          grid-template-columns: 1fr;
        }
        
        .form-actions {
          flex-direction: column;
          align-items: center;
        }
        
        .action-btn {
          width: 100%;
          max-width: 300px;
        }
        
        .status-group {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.75rem;
        }
        
        .section-title {
          font-size: 1.1rem;
        }
      }
      
      @media (max-width: 480px) {
        .container {
          padding: 1rem 0.8rem;
        }
        
        h1 {
          font-size: 1.4rem;
        }
        
        .form-input {
          padding: 0.6rem 0.8rem;
          font-size: 0.9rem;
        }
        
        .input-with-icon {
          padding-left: 2.2rem;
        }
        
        .input-icon {
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üì± Assign Number to Group</h1>
      
      <div class="notification" id="notification"></div>
      
      <form id="assignForm">
        <div class="form-section">
          <div class="section-title">
            üìû Phone Number Details
          </div>
          <div class="form-grid">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">
                  Country Code
                  <span class="required-indicator">*</span>
                </label>
                <div class="input-group">
                  <span class="input-icon">üåç</span>
                  <input 
                    type="text" 
                    name="countryCode" 
                    class="form-input input-with-icon" 
                    placeholder="e.g., +1, +91, +44" 
                    required 
                    pattern="^\+?[1-9]\d{0,3}$"
                    title="Please enter a valid country code (e.g., +1, +91, +44)"
                  />
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">
                  Phone Number
                  <span class="required-indicator">*</span>
                </label>
                <div class="input-group">
                  <span class="input-icon">üì±</span>
                  <input 
                    type="tel" 
                    name="number" 
                    class="form-input input-with-icon" 
                    placeholder="Enter phone number" 
                    required 
                    pattern="^[0-9]{7,15}$"
                    title="Please enter a valid phone number (7-15 digits)"
                  />
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Custom Message (Optional)</label>
              <div class="input-group">
                <span class="input-icon">üí¨</span>
                <input 
                  type="text" 
                  name="message" 
                  class="form-input input-with-icon" 
                  placeholder="Enter custom WhatsApp message (optional)" 
                  maxlength="200"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">
            üè∑Ô∏è Group Assignment
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                Select Group
                <span class="required-indicator">*</span>
              </label>
              <div class="input-group">
                <span class="input-icon">üìÇ</span>
                <select name="group" class="form-input input-with-icon" required>
                  <option value="">Choose a group...</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Status</label>
              <div class="status-group">
                <label class="status-option">
                  <input type="radio" name="status" value="active" checked />
                  <span>‚úÖ Active</span>
                </label>
                <label class="status-option">
                  <input type="radio" name="status" value="inactive" />
                  <span>‚ùå Inactive</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="preview-section">
          <div class="preview-title">
            üëÄ Preview
          </div>
          <div class="preview-content" id="previewContent">
            Fill in the form to see a preview of the WhatsApp number assignment...
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="action-btn">
            ‚úÖ Assign Number
          </button>
          <button type="button" class="action-btn secondary" onclick="resetForm()">
            üîÑ Reset Form
          </button>
        </div>
      </form>
      
      <a class="back-link" href="/admin">‚Üê Back to Admin</a>
    </div>

    <script>
      let currentGroups = [];

      // Show notification
      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        setTimeout(() => {
          notification.classList.remove('show');
        }, 5000);
      }

      // Update preview
      function updatePreview() {
        const form = document.getElementById('assignForm');
        const formData = new FormData(form);
        const countryCode = formData.get('countryCode') || '[Country Code]';
        const number = formData.get('number') || '[Phone Number]';
        const message = formData.get('message') || '[No custom message]';
        const group = formData.get('group') || '[No group selected]';
        const status = formData.get('status') || 'active';
        
        const preview = document.getElementById('previewContent');
        preview.textContent = `üì± Number: ${countryCode} ${number}
üè∑Ô∏è Group: ${group}
üí¨ Message: ${message}
üìä Status: ${status.charAt(0).toUpperCase() + status.slice(1)}

üîó This number will be available for WhatsApp redirects in the "${group}" group.`;
      }

      // Fetch and load groups from backend
      async function loadGroups() {
        try {
          const res = await fetch("/api/groups");
          if (!res.ok) throw new Error('Failed to load groups');
          
          const groups = await res.json();
          currentGroups = groups;
          
          const groupSelect = document.querySelector('select[name="group"]');
          groupSelect.innerHTML = '<option value="">Choose a group...</option>';
          
          groups.forEach(group => {
            const option = document.createElement("option");
            option.value = group;
            option.textContent = group;
            groupSelect.appendChild(option);
          });
          
          if (groups.length === 0) {
            showNotification('No groups available. Please create a group first.', 'error');
          }
        } catch (error) {
          showNotification('Failed to load groups: ' + error.message, 'error');
        }
      }

      // Reset form
      function resetForm() {
        if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
          document.getElementById('assignForm').reset();
          updatePreview();
        }
      }

      // Form validation
      function validateForm(formData) {
        const countryCode = formData.get('countryCode');
        const number = formData.get('number');
        const group = formData.get('group');
        
        if (!countryCode || !number || !group) {
          throw new Error('Please fill in all required fields.');
        }
        
        if (!/^\+?[1-9]\d{0,3}$/.test(countryCode)) {
          throw new Error('Please enter a valid country code (e.g., +1, +91, +44).');
        }
        
        if (!/^[0-9]{7,15}$/.test(number)) {
          throw new Error('Please enter a valid phone number (7-15 digits).');
        }
        
        if (!currentGroups.includes(group)) {
          throw new Error('Selected group is not valid.');
        }
      }

      // Form submit handler
      document.getElementById("assignForm").onsubmit = async function (e) {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        try {
          const formData = new FormData(this);
          
          // Validate form
          validateForm(formData);
          
          // Show confirmation
          const countryCode = formData.get('countryCode');
          const number = formData.get('number');
          const group = formData.get('group');
          const status = formData.get('status');
          const message = formData.get('message') || 'No custom message';
          
          const confirmMessage = `Are you sure you want to assign this number to the group?

üì± Number: ${countryCode} ${number}
üè∑Ô∏è Group: ${group}
üí¨ Message: ${message}
üìä Status: ${status.charAt(0).toUpperCase() + status.slice(1)}

This will make the number available for WhatsApp redirects in the "${group}" group.`;
          
          if (!confirm(confirmMessage)) {
            return;
          }
          
          // Disable submit button
          submitBtn.disabled = true;
          submitBtn.textContent = '‚è≥ Assigning...';
          
          const data = new URLSearchParams(formData);
          const res = await fetch("/api/assign-number", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: data
          });

          if (res.ok) {
            showNotification(`‚úÖ Number ${countryCode} ${number} assigned to group "${group}" successfully!`, 'success');
            this.reset();
            updatePreview();
          } else {
            const result = await res.json().catch(() => null);
            throw new Error(result?.message || 'Unknown error occurred');
          }
        } catch (error) {
          showNotification(`‚ùå Assignment failed: ${error.message}`, 'error');
        } finally {
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      };

      // Add event listeners for real-time preview
      document.getElementById('assignForm').addEventListener('input', updatePreview);
      document.getElementById('assignForm').addEventListener('change', updatePreview);

      // Initialize
      loadGroups();
      updatePreview();
    </script>
  </body>
</html>