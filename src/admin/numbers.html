<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage WhatsApp Numbers</title>
  <link rel="stylesheet" href="/public/style.css" />
</head>
<body>
  <h1>WhatsApp Numbers</h1>
  <form id="addForm">
    <input name="countryCode" placeholder="Country Code" required>
    <input name="number" placeholder="Number" required>
    <label>
      <input type="checkbox" name="status" value="active" checked>
      Active
    </label>
    <button>Add</button>
  </form>
  <table border="1" id="numbersTable">
    <thead>
      <tr>
        <th>Country Code</th>
        <th>Number</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Edit Modal -->
  <div id="editModal" style="display:none; position:fixed; top:20%; left:40%; background:#fff; border:1px solid #ccc; padding:20px;">
    <form id="editForm">
      <input type="hidden" name="index" id="editIndex">
      <label>Country Code: <input name="countryCode" id="editCountryCode" required></label><br>
      <label>Number: <input name="number" id="editNumber" required></label><br>
      <label>
        <input type="checkbox" name="status" id="editStatus" value="active">
        Active
      </label><br>
      <button type="submit">Save</button>
      <button type="button" onclick="closeEditModal()">Cancel</button>
    </form>
  </div>

  <a href="/admin">Back to Admin</a>
  <script>
    async function loadNumbers() {
      const res = await fetch('/api/numbers');
      const numbers = await res.json();
      const tbody = document.querySelector('#numbersTable tbody');
      tbody.innerHTML = '';
      numbers.forEach((n, i) => {
        const checked = n.status === 'active' ? 'checked' : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${n.countryCode}</td>
          <td>${n.number}</td>
          <td>
            <input type="checkbox" ${checked} onchange="updateStatus(${i}, this.checked)">
            <span>${n.status === 'active' ? 'Active' : 'Inactive'}</span>
          </td>
          <td>
            <button onclick="editNumber(${i})">Edit</button>
            <button onclick="deleteNumber(${i})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function editNumber(index) {
      fetch('/api/numbers')
        .then(res => res.json())
        .then(numbers => {
          const n = numbers[index];
          document.getElementById('editIndex').value = index;
          document.getElementById('editCountryCode').value = n.countryCode;
          document.getElementById('editNumber').value = n.number;
          document.getElementById('editStatus').checked = n.status === 'active';
          document.getElementById('editModal').style.display = 'block';
        });
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editForm').onsubmit = async e => {
      e.preventDefault();
      const index = document.getElementById('editIndex').value;
      const countryCode = document.getElementById('editCountryCode').value;
      const number = document.getElementById('editNumber').value;
      const status = document.getElementById('editStatus').checked ? 'active' : 'inactive';
      await fetch('/api/numbers/edit', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `index=${index}&countryCode=${encodeURIComponent(countryCode)}&number=${encodeURIComponent(number)}&status=${status}`
      });
      closeEditModal();
      loadNumbers();
    };

    async function updateStatus(index, checked) {
      const status = checked ? 'active' : 'inactive';
      await fetch('/api/numbers/status', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `index=${index}&status=${status}`
      });
      loadNumbers();
    }
    async function deleteNumber(index) {
      await fetch('/api/numbers/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'index=' + encodeURIComponent(index)
      });
      loadNumbers();
    }
    document.getElementById('addForm').onsubmit = async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const status = fd.get('status') === 'active' ? 'active' : 'inactive';
      const data = new URLSearchParams(fd);
      data.set('status', status);
      await fetch('/api/numbers', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: data
      });
      e.target.reset();
      loadNumbers();
    };
    loadNumbers();
  </script>
</body>
</html>